<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>台灣壽險業 RBC 精確數據看板 (安達/法巴修正版)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #2980b9;
            --bg: #f8f9fa;
            --sidebar-w: 260px;
        }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; background: var(--bg); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Header */
        header { height: 50px; background: var(--primary); color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 100; }
        h1 { margin: 0; font-size: 1rem; font-weight: bold; letter-spacing: 1px; }
        .source-badge { font-size: 0.75rem; background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.3); }

        /* Layout */
        .container { display: flex; flex: 1; overflow: hidden; position: relative; }
        
        /* Sidebar */
        .sidebar { width: var(--sidebar-w); background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; padding: 10px; overflow-y: auto; flex-shrink: 0; z-index: 50; }
        .sidebar h3 { font-size: 0.85rem; color: #7f8c8d; margin: 10px 0 5px 0; border-bottom: 2px solid #eee; padding-bottom: 5px; font-weight: bold; }
        
        button.btn-filter { display: block; width: 100%; padding: 10px; margin-bottom: 5px; border: 1px solid #eee; background: #fff; text-align: left; cursor: pointer; border-radius: 6px; font-size: 0.9rem; transition: 0.2s; }
        button.btn-filter:hover { background: #eaf2f8; border-color: var(--accent); color: var(--accent); }
        button.btn-filter strong { display: block; font-size: 0.75rem; color: #888; margin-top: 3px; font-weight: normal; }

        /* 倍安專屬按鈕樣式 */
        button.btn-beian { 
            border: 2px solid #9b59b6; 
            background-color: #fcf4ff; 
            color: #8e44ad; 
            font-weight: bold;
        }
        button.btn-beian:hover { background-color: #f5eef9; }
        button.btn-beian strong { color: #9b59b6; }
        
        /* 全選按鈕 */
        button.btn-all { background-color: #e0e0e0; border-color: #bbb; color: #333; font-weight: bold; }

        .toggle-btn { background: var(--accent); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-bottom: 10px; width: 100%; font-size: 0.95rem; }
        
        .checkbox-item { display: flex; align-items: center; gap: 8px; padding: 8px 5px; cursor: pointer; font-size: 0.9rem; border-bottom: 1px solid #f9f9f9; }
        .checkbox-item input { transform: scale(1.3); margin: 0; }

        /* Content */
        .content { flex: 1; padding: 15px; display: flex; flex-direction: column; position: relative; overflow: hidden; min-width: 0; }
        .chart-box { flex: 1; background: white; padding: 10px; border-radius: 8px; border: 1px solid #ddd; position: relative; min-height: 0; }
        .table-box { flex: 1; background: white; border-radius: 8px; border: 1px solid #ddd; overflow: auto; display: none; -webkit-overflow-scrolling: touch; }

        /* Table */
        table { width: 100%; border-collapse: separate; border-spacing: 0; white-space: nowrap; font-size: 0.85rem; }
        th, td { padding: 10px 12px; text-align: center; border-bottom: 1px solid #eee; border-right: 1px solid #eee; }
        thead th { position: sticky; top: 0; background: var(--primary); color: white; z-index: 10; padding: 10px; }
        tbody td:first-child { position: sticky; left: 0; background: #f8f9fa; font-weight: bold; border-right: 2px solid #ccc; z-index: 11; color: var(--primary); }
        thead th:first-child { position: sticky; left: 0; z-index: 12; background: var(--primary); color: #f1c40f; }
        tbody tr:hover td { background: #fff8e1; }

        /* Status Colors */
        .val-danger { color: #c0392b; font-weight: bold; background: #fadbd8; }
        .val-high { color: #27ae60; font-weight: bold; }
        .val-extreme { color: #8e44ad; font-weight: 800; }
        .footer { font-size: 0.75rem; color: #777; margin-top: 10px; text-align: right; border-top: 1px solid #ddd; padding-top: 5px; }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container { flex-direction: column; overflow: visible; height: auto; }
            body { overflow-y: auto; height: auto; }
            .sidebar { width: 100%; max-height: 350px; border-right: none; border-bottom: 2px solid #ddd; }
            .content { height: 600px; overflow: visible; flex: none; }
            .chart-box { min-height: 400px; }
            h1 { font-size: 0.9rem; }
            .source-badge { display: none; }
        }
    </style>
</head>
<body>

<header>
    <h1>壽險業 RBC 檔案還原數據</h1>
    <div class="source-badge">資料來源：上傳檔案 (104-114)</div>
</header>

<div class="container">
    <div class="sidebar">
        <button class="toggle-btn" onclick="toggleView()">切換檢視：圖表 / 表格</button>

        <h3>合作夥伴專區</h3>
        <button class="btn-filter btn-beian" onclick="filter('beian')">
            ★ 倍安代理 (9家)
            <strong>新光、台灣、全球、遠雄、安達、友邦、保誠、元大、富邦</strong>
        </button>

        <h3>一般分類</h3>
        <button class="btn-filter" onclick="filter('top6')">六大壽險</button>
        <button class="btn-filter" onclick="filter('high')">高資本群 (安聯/法巴...)</button>
        <button class="btn-filter" onclick="filter('watch')">觀察名單 (三商/宏泰)</button>
        
        <button class="btn-filter" style="background:#f1f1f1; border-color:#ccc;" onclick="reset()">清除所有選擇</button>
        <button class="btn-filter btn-all" onclick="selectAll()">顯示全部 (21家)</button>

        <h3>公司列表</h3>
        <div id="checkboxList"></div>
    </div>

    <div class="content">
        <div id="chartContainer" class="chart-box">
            <canvas id="myChart"></canvas>
        </div>
        <div id="tableContainer" class="table-box">
            <table id="dataTable">
                <thead><tr id="tableHead"></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        <div class="footer">
            * 資料來源：上傳Excel檔案與截圖校正 | 安達與法巴數據已正確歸位
        </div>
    </div>
</div>

<script>
    // =========================================================================
    // 資料來源：依據上傳檔案內容 (File Content) + 截圖校正
    // 期間：104上 - 114上 (共21個數據點)
    // =========================================================================
    const labels = [
        "104上", "104全", "105上", "105全", "106上", "106全", "107上", "107全",
        "108上", "108全", "109上", "109全", "110上", "110全", "111上", "111全",
        "112上", "112全", "113上", "113全", "114上"
    ];

    const db = [
        // --- 本次修正：安達、法巴 ---
        { 
            c: "安達人壽", 
            // 依據截圖 7.02.02.png (Chubb): 300, 569, 673, 587, 463, 298, 286, 369, 418, 355, 352, 336, 300, 310, 352, 545, 662, 681, 623, 569, null
            data: [300, 569, 673, 587, 463, 298, 286, 369, 418, 355, 352, 336, 300, 310, 352, 545, 662, 681, 623, 569, null] 
        },
        { 
            c: "法國巴黎", 
            // 依據截圖 6.59.06.png (BNP): 300, 415, 683, 896, 818, 787, 805, 786, 807, 769, 1094, 1223, 1348, 1094, 976, 1380, 2176, 2291, 1672, 1012, 842
            data: [300, 415, 683, 896, 818, 787, 805, 786, 807, 769, 1094, 1223, 1348, 1094, 976, 1380, 2176, 2291, 1672, 1012, 842] 
        },

        // --- 倍安代理 (9家) 其餘成員 ---
        { c: "新光人壽", data: [300, 268, 227, 279, 274, 257, 268, 227, 244, 221, 211, 213, 221, 230, 238, 214, 184, 176, 201, 221, 205] },
        { c: "台灣人壽", data: [275, 324, 288, 281, 345, 340, 320, 268, 322, 298, 293, 309, 306, 342, 312, 275, 289, 305, 328, 318, 323] },
        { c: "全球人壽", data: [300, 754, 627, 591, 522, 535, 505, 427, 430, 372, 359, 353, 388, 366, 427, 366, 317, 278, 288, 274, 212] },
        { c: "遠雄人壽", data: [300, 371, 362, 337, 337, 326, 326, 276, 300, 269, 257, 278, 290, 311, 322, 325, 322, 317, 303, 300, 333] },
        { c: "友邦人壽", data: [300, 441, 417, 439, 412, 381, 395, 381, 361, 363, 322, 439, 507, 564, 660, 649, 563, 530, 424, 441, 486] },
        { c: "保誠人壽", data: [300, 386, 301, 423, 399, 366, 446, 493, 399, 324, 435, 316, 307, 339, 545, 458, 331, 315, 292, 294, 264] },
        { c: "元大人壽", data: [300, 410, 358, 293, 414, 313, 358, 367, 327, 300, 469, 597, 445, 561, 518, 503, 498, 465, 368, 396, 415] },
        { c: "富邦人壽", data: [300, 256, 262, 301, 284, 318, 327, 278, 288, 281, 248, 299, 333, 338, 349, 317, 315, 336, 388, 371, 405] },

        // --- 其他公司 ---
        { c: "國泰人壽", data: [275, 305, 288, 305, 308, 309, 325, 292, 333, 346, 347, 360, 371, 371, 337, 316, 312, 323, 359, 352, 328] },
        { c: "南山人壽", data: [275, 239, 237, 257, 272, 268, 272, 215, 258, 274, 256, 260, 295, 327, 318, 292, 286, 280, 282, 299, 276] },
        { c: "凱基人壽", data: [300, 357, 339, 369, 334, 350, 303, 272, 319, 305, 276, 288, 306, 325, 331, 280, 300, 340, 323, 398, 347] },
        { c: "安聯人壽", data: [225, 237, 325, 286, 248, 340, 335, 312, 493, 646, 707, 775, 842, 732, 761, 721, 577, 780, 469, 468, 447] },
        { c: "臺銀人壽", data: [225, 233, 213, 189, 151, 154, 303, 258, 268, 223, 212, 176, 297, 288, 307, 282, 312, 298, 336, 356, 204] },
        { c: "中華郵政", data: [300, 324, 311, 351, 322, 355, 324, 291, 280, 251, 212, 291, 307, 333, 264, 324, 290, 256, 310, 274, 231] },
        { c: "合庫人壽", data: [300, 887, 1078, 1016, 1100, 1152, 1162, 1098, 1311, 1148, 1592, 1618, 1784, 1503, 1301, 1403, 1563, 1576, 1373, 1285, 1415] },
        { c: "第一金人壽", data: [300, 356, 379, 328, 263, 231, 454, 407, 320, 344, 368, 326, 394, 377, 614, 609, 488, 471, 425, 424, 359] },
        { c: "台新人壽", data: [300, 393, 393, 362, 320, 315, 327, 308, 325, 302, 287, 269, 320, 317, 410, 371, 339, 353, 323, 349, 456] },
        { c: "三商美邦", data: [225, 219, 211, 231, 226, 227, 217, 218, 208, 218, 210, 205, 210, 204, 190, 156, 140, 111, 151, 136, 154] },
        { c: "宏泰人壽", data: [150, 307, 291, 295, 309, 290, 251, 225, 227, 239, 207, 164, 232, 259, 228, 205, 146, 215, 242, 272, 250] }
    ];

    const groups = {
        beian: ["新光人壽", "台灣人壽", "全球人壽", "遠雄人壽", "安達人壽", "友邦人壽", "保誠人壽", "元大人壽", "富邦人壽"],
        top6: ["國泰人壽", "富邦人壽", "南山人壽", "新光人壽", "凱基人壽", "台灣人壽"],
        watch: ["三商美邦", "新光人壽", "宏泰人壽"],
        high: ["安聯人壽", "友邦人壽", "安達人壽", "法國巴黎"]
    };

    let chartInstance = null;
    let isTableView = false;

    function init() {
        const cbList = document.getElementById('checkboxList');
        db.forEach(item => {
            const div = document.createElement('label');
            div.className = 'checkbox-item';
            div.innerHTML = `<input type="checkbox" value="${item.c}" onchange="refresh()"> ${item.c}`;
            cbList.appendChild(div);
        });
        filter('beian'); // 預設顯示倍安代理
    }

    function filter(key) {
        const targets = groups[key] || [];
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.checked = targets.includes(cb.value);
        });
        refresh();
    }

    function selectAll() {
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.checked = true;
        });
        refresh();
    }

    function reset() {
        document.querySelectorAll('input').forEach(i => i.checked = false);
        refresh();
    }

    function refresh() {
        const selected = Array.from(document.querySelectorAll('input:checked')).map(i => i.value);
        if(selected.length === 0) {
            if(chartInstance) chartInstance.destroy();
            document.getElementById('tableBody').innerHTML = '';
            return;
        }
        updateChart(selected);
        updateTable(selected);
    }

    function updateChart(selectedNames) {
        const ctx = document.getElementById('myChart').getContext('2d');
        const datasets = selectedNames.map((name, idx) => {
            const item = db.find(d => d.c === name);
            let color = `hsl(${idx * 40 % 360}, 70%, 50%)`;
            if(name === "三商美邦") color = "#c0392b";
            if(name === "安達人壽") color = "#8e44ad";
            if(name === "法國巴黎") color = "#27ae60";
            
            return {
                label: name,
                data: item.data,
                borderColor: color,
                backgroundColor: color,
                borderWidth: 2,
                tension: 0.1,
                pointRadius: 3,
                spanGaps: true
            };
        });

        datasets.push({
            label: '法定標準 200%',
            data: Array(labels.length).fill(200),
            borderColor: 'red',
            borderWidth: 2,
            borderDash: [5, 5],
            pointRadius: 0,
            order: 999
        });

        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    y: { beginAtZero: false, title: { display: true, text: 'RBC (%)' } }
                },
                plugins: {
                    tooltip: { mode: 'index', intersect: false }
                }
            }
        });
    }

    function updateTable(selectedNames) {
        const thead = document.getElementById('tableHead');
        const tbody = document.getElementById('tableBody');
        
        thead.innerHTML = `<th>公司 \\ 期別</th>` + labels.map(l => `<th>${l}</th>`).join('');
        tbody.innerHTML = '';
        
        selectedNames.forEach(name => {
            const item = db.find(d => d.c === name);
            const tr = document.createElement('tr');
            let html = `<td>${name}</td>`;
            
            item.data.forEach(val => {
                let cls = '';
                let display = '-';
                if(val !== null) {
                    display = val + '%';
                    if(val < 200) cls = 'val-danger';
                    else if(val > 800) cls = 'val-extreme';
                    else if(val > 400) cls = 'val-high';
                }
                html += `<td class="${cls}">${display}</td>`;
            });
            tr.innerHTML = html;
            tbody.appendChild(tr);
        });
    }

    function toggleView() {
        isTableView = !isTableView;
        const chartBox = document.getElementById('chartContainer');
        const tableBox = document.getElementById('tableContainer');
        const btn = document.querySelector('.toggle-btn');

        if(isTableView) {
            chartBox.style.display = 'none';
            tableBox.style.display = 'block';
            btn.innerText = "切換至：趨勢圖表";
        } else {
            chartBox.style.display = 'block';
            tableBox.style.display = 'none';
            btn.innerText = "切換至：詳細表格";
        }
    }

    init();
</script>
</body>
</html>
