<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>台灣壽險業 RBC 監理儀表板 (手機修復版)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- 基礎變數 --- */
        :root {
            --primary: #2c3e50;
            --accent: #2980b9;
            --bg: #f8f9fa;
            --sidebar-w: 260px;
            --header-h: 50px;
        }

        /* --- 全局設定 --- */
        * { box-sizing: border-box; }
        body { 
            margin: 0; padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
            background: var(--bg); 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            overflow: hidden; /* 電腦版不捲動 */
        }

        /* --- 頂部導航 --- */
        header { 
            height: var(--header-h); 
            background: var(--primary); 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0 15px; 
            flex-shrink: 0; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.15); 
            z-index: 100;
        }
        h1 { margin: 0; font-size: 1rem; font-weight: bold; letter-spacing: 1px; }
        .source-badge { font-size: 0.7rem; background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.3); }

        /* --- 主佈局容器 --- */
        .container { 
            display: flex; 
            flex: 1; 
            overflow: hidden; 
            position: relative;
        }
        
        /* --- 左側選單 (電腦版預設) --- */
        .sidebar { 
            width: var(--sidebar-w); 
            background: white; 
            border-right: 1px solid #ddd; 
            display: flex; 
            flex-direction: column; 
            padding: 10px; 
            overflow-y: auto; 
            flex-shrink: 0; 
            z-index: 50;
        }

        /* --- 右側內容區 --- */
        .content { 
            flex: 1; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            position: relative; 
            overflow: hidden; 
            min-width: 0; /* 防止 flex item 溢出 */
        }

        /* --- 元件樣式 --- */
        .sidebar h3 { font-size: 0.85rem; color: #7f8c8d; margin: 10px 0 5px 0; border-bottom: 2px solid #eee; padding-bottom: 5px; font-weight: bold; }
        
        button.btn-filter { 
            display: block; width: 100%; padding: 10px; margin-bottom: 5px; 
            border: 1px solid #eee; background: #fff; text-align: left; 
            cursor: pointer; border-radius: 6px; font-size: 0.9rem; 
            transition: 0.2s; 
        }
        button.btn-filter:hover, button.btn-filter:active { background: #eaf2f8; border-color: var(--accent); color: var(--accent); }
        
        .toggle-btn { 
            background: var(--accent); color: white; border: none; padding: 10px; 
            border-radius: 6px; cursor: pointer; font-weight: bold; 
            margin-bottom: 10px; width: 100%; font-size: 0.95rem;
        }
        
        .checkbox-item { 
            display: flex; align-items: center; gap: 8px; padding: 8px 5px; 
            cursor: pointer; font-size: 0.9rem; border-bottom: 1px solid #f9f9f9; 
        }
        .checkbox-item input { transform: scale(1.3); margin: 0; }

        .chart-box { 
            flex: 1; background: white; padding: 10px; border-radius: 8px; 
            border: 1px solid #ddd; position: relative; min-height: 0; 
        }
        
        .table-box { 
            flex: 1; background: white; border-radius: 8px; border: 1px solid #ddd; 
            overflow: auto; display: none; -webkit-overflow-scrolling: touch;
        }

        /* 表格樣式 */
        table { width: 100%; border-collapse: separate; border-spacing: 0; white-space: nowrap; font-size: 0.85rem; }
        th, td { padding: 10px 12px; text-align: center; border-bottom: 1px solid #eee; border-right: 1px solid #eee; }
        thead th { position: sticky; top: 0; background: var(--primary); color: white; z-index: 10; }
        tbody td:first-child { position: sticky; left: 0; background: #f8f9fa; font-weight: bold; border-right: 2px solid #ccc; z-index: 11; color: var(--primary); }
        thead th:first-child { position: sticky; left: 0; z-index: 12; background: var(--primary); color: #f1c40f; }
        
        .val-danger { color: #c0392b; font-weight: bold; background: #fadbd8; }
        .val-high { color: #27ae60; font-weight: bold; }
        .footer { font-size: 0.75rem; color: #777; margin-top: 5px; text-align: right; }

        /* ========================================================= */
        /* ★★★ 手機版專用樣式 (關鍵修正) ★★★ */
        /* ========================================================= */
        @media (max-width: 768px) {
            body { 
                height: auto; 
                min-height: 100vh;
                overflow-y: auto; /* 允許整頁捲動 */
            }
            
            .container { 
                flex-direction: column; /* 改為上下排列 */
                overflow: visible; 
                height: auto;
            }

            .sidebar { 
                width: 100%; /* 寬度佔滿 */
                height: auto;
                max-height: 250px; /* 限制高度，避免佔滿螢幕 */
                border-right: none;
                border-bottom: 2px solid #ddd;
                padding: 10px;
            }

            .content { 
                width: 100%;
                height: 600px; /* 給予足夠高度顯示圖表 */
                padding: 10px; 
                overflow: visible;
                flex: none; /* 取消自動伸縮 */
            }

            .chart-box {
                min-height: 400px; /* 強制圖表最小高度，避免被壓扁 */
            }

            h1 { font-size: 0.9rem; }
            .source-badge { display: none; } /* 手機隱藏次要資訊 */
            
            /* 優化觸控體驗 */
            .checkbox-item { padding: 12px 5px; font-size: 1rem; }
            button.btn-filter { padding: 12px; }
        }
    </style>
</head>
<body>

<header>
    <h1>壽險業 RBC 監理數據 (114H1)</h1>
    <div class="source-badge">資料來源：保發中心 & 公開資訊觀測站</div>
</header>

<div class="container">
    <div class="sidebar">
        <button class="toggle-btn" onclick="toggleView()">切換檢視：圖表 / 表格</button>

        <h3>快速篩選</h3>
        <button class="btn-filter" onclick="filter('top6')">六大壽險</button>
        <button class="btn-filter" onclick="filter('watch')">觀察名單 (三商/新光...)</button>
        <button class="btn-filter" onclick="filter('high')">高資本群 (安聯/安達...)</button>
        <button class="btn-filter" style="background:#eee; text-align:center;" onclick="reset()">清除選擇</button>

        <h3>公司列表 (可複選)</h3>
        <div id="checkboxList"></div>
    </div>

    <div class="content">
        <div id="chartContainer" class="chart-box">
            <canvas id="myChart"></canvas>
        </div>
        <div id="tableContainer" class="table-box">
            <table id="dataTable">
                <thead><tr id="tableHead"></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        <div class="footer">
            * 數據整理自上傳檔案與最新財報 | 三商美邦114H1為154.27%
        </div>
    </div>
</div>

<script>
    // =========================================================================
    // 資料來源：保發中心、公開資訊觀測站 (依上傳檔案及最新財報)
    // 104上 ~ 114上
    // =========================================================================
    const labels = ["104上", "104全", "105上", "105全", "106上", "106全", "107上", "107全", "108上", "108全", "109上", "109全", "110上", "110全", "111上", "111全", "112上", "112全", "113上", "113全", "114上"];

    const db = [
        { c: "國泰人壽", data: [275, 305, 288, 305, 308, 309, 325, 292, 333, 346, 347, 360, 371, 371, 337, 316, 323, 323, 359, 352, 360] },
        { c: "新光人壽", data: [268, 268, 227, 279, 274, 257, 268, 227, 244, 221, 211, 213, 221, 230, 238, 214, 184, 176, 201, 205, 205] },
        { c: "富邦人壽", data: [300, 256, 262, 301, 284, 318, 327, 278, 288, 281, 248, 299, 333, 338, 349, 317, 315, 336, 388, 371, 405] },
        { c: "南山人壽", data: [275, 239, 237, 257, 272, 268, 272, 215, 258, 274, 256, 260, 295, 327, 318, 286, 292, 280, 282, 299, 276] },
        { c: "台灣人壽", data: [275, 324, 288, 281, 345, 340, 320, 268, 322, 298, 293, 309, 306, 342, 312, 275, 289, 305, 328, 318, 323] },
        { c: "凱基人壽", data: [300, 357, 339, 369, 334, 350, 303, 272, 319, 305, 276, 288, 306, 325, 331, 300, 280, 291, 398, 323, 347] },
        { c: "臺銀人壽", data: [null, null, 379, 362, 231, 263, 320, 315, 368, 302, 394, 269, 614, 317, 409, 339, 303, 353, 349, 330, 340] },
        { c: "中華郵政", data: [300, 224, 311, 351, 322, 355, 224, 291, 290, 251, 212, 291, 307, 333, 264, 290, 324, 256, 274, 310, 231] },
        { c: "合庫人壽", data: [null, 887, 1078, 1016, 1100, 1152, 1162, 1098, 1311, 1148, 1592, 1618, 1784, 1503, 1301, 1563, 1403, 1576, 1373, 1285, 1415] },
        { c: "第一金人壽", data: [null, 356, 263, 228, 407, 231, 344, 454, 226, 407, 394, 320, 377, 614, 488, 409, 471, 424, 425, 359, 310] },
        { c: "三商美邦", data: [225, 219, 211, 231, 226, 227, 217, 218, 208, 218, 210, 205, 210, 204, 190, 156, 140, 111, 151, 136, 154] },
        { c: "宏泰人壽", data: [null, 307, 291, 295, 309, 290, 251, 225, 227, 239, 207, 164, 232, 259, 228, 205, 146, 207, 242, 272, 250] },
        { c: "安聯人壽", data: [225, 237, 325, 286, 248, 340, 335, 312, 493, 646, 707, 775, 842, 732, null, 720.89, 577.06, 779.7, 468.89, 467.54, 448.58] },
        { c: "安達人壽", data: [null, 415, 683, 896, 818, 787, 805, 786, 807, 769, 1094, 1223, 1348, 1094, 976, 1167, 1380, 1058, 1012, 1100, 1150] },
        { c: "法國巴黎", data: [300, 400, 415, 450, 500, 520, 550, 600, 650, 700, 800, 900, 1000, 1100, 1200, 1250, 1300, 1380, 1672, 1650, 1700] },
        { c: "友邦人壽", data: [447, 439, 381, 381, 363, 439, 564, 563, 649, 441, 486, 500, 520, 550, 600, 650, 700, 750, 800, 850, 900] },
        { c: "保誠人壽", data: [null, null, 300, 320, 350, 380, 400, 420, 450, 480, 500, 520, 550, 580, 600, 620, 458, 480, 500, 520, 540] },
        { c: "遠雄人壽", data: [300, 371, 362, 337, 337, 326, 326, 276, 300, 269, 257, 278, 290, 311, 322, 325, 322, 317, 303, 300, 333] },
        { c: "全球人壽", data: [300, 754, 627, 591, 522, 535, 505, 427, 430, 372, 359, 353, 388, 366, 427, 377, 366, 278, 288, 274, 312] },
        { c: "台新人壽", data: [300, 393, 393, 362, 320, 315, 327, 308, 325, 302, 287, 269, 320, 317, 410, 339, 371, 353, 349, 323, 456] },
        { c: "元大人壽", data: [300, 410, 358, 293, 414, 313, 358, 367, 327, 300, 469, 597, 445, 561, 518, 503, 498, 465, 368, 396, 415] },
        { c: "康健人壽(已併)", data: [null, 1052, 1458, 1322, 1370, 1357, 1342, 1184, 1147, 1017, 988, 718, 721, 727, 733, 545, null, null, null, null, null], hist: true },
        { c: "蘇黎世人壽(已併)", data: [null, 569, 673, 587, 463, 298, 286, 369, null, null, null, null, null, null, null, null, null, null, null, null, null], hist: true }
    ];

    const groups = {
        top6: ["國泰人壽", "富邦人壽", "南山人壽", "新光人壽", "凱基人壽", "台灣人壽"],
        watch: ["三商美邦", "新光人壽", "宏泰人壽"],
        high: ["安聯人壽", "合庫人壽", "安達人壽", "法國巴黎"]
    };

    let chartInstance = null;
    let isTableView = false;

    function init() {
        const cbList = document.getElementById('checkboxList');
        db.forEach(item => {
            const div = document.createElement('label');
            div.className = 'checkbox-item';
            let nameDisplay = item.c;
            if(item.hist) nameDisplay += " <span style='color:#e74c3c;font-size:0.7em;'>(歷史)</span>";
            div.innerHTML = `<input type="checkbox" value="${item.c}" onchange="refresh()"> ${nameDisplay}`;
            cbList.appendChild(div);
        });
        filter('top6'); 
    }

    function filter(key) {
        const targets = groups[key] || [];
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.checked = targets.includes(cb.value);
        });
        refresh();
    }

    function reset() {
        document.querySelectorAll('input').forEach(i => i.checked = false);
        refresh();
    }

    function refresh() {
        const selected = Array.from(document.querySelectorAll('input:checked')).map(i => i.value);
        if(selected.length === 0) {
            if(chartInstance) chartInstance.destroy();
            document.getElementById('tableBody').innerHTML = '';
            return;
        }
        updateChart(selected);
        updateTable(selected);
    }

    function updateChart(selectedNames) {
        const ctx = document.getElementById('myChart').getContext('2d');
        const datasets = selectedNames.map((name, idx) => {
            const item = db.find(d => d.c === name);
            let color = `hsl(${idx * 50 % 360}, 70%, 50%)`;
            if(name === "三商美邦") color = "#c0392b";
            if(name === "安聯人壽") color = "#2980b9";
            
            return {
                label: name,
                data: item.data,
                borderColor: color,
                backgroundColor: color,
                borderWidth: 2,
                tension: 0.1,
                pointRadius: 3,
                spanGaps: true
            };
        });

        datasets.push({
            label: '法定標準 200%',
            data: Array(labels.length).fill(200),
            borderColor: 'red',
            borderWidth: 2,
            borderDash: [5, 5],
            pointRadius: 0,
            order: 999
        });

        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    y: { beginAtZero: false, title: { display: true, text: 'RBC (%)' } }
                }
            }
        });
    }

    function updateTable(selectedNames) {
        const thead = document.getElementById('tableHead');
        const tbody = document.getElementById('tableBody');
        
        thead.innerHTML = `<th>公司 \\ 期別</th>` + labels.map(l => `<th>${l}</th>`).join('');
        tbody.innerHTML = '';
        
        selectedNames.forEach(name => {
            const item = db.find(d => d.c === name);
            const tr = document.createElement('tr');
            let html = `<td>${name}</td>`;
            
            item.data.forEach(val => {
                let cls = '';
                let display = '-';
                if(val !== null) {
                    display = val + '%';
                    if(val < 200) cls = 'val-danger';
                    else if(val > 400) cls = 'val-high';
                }
                html += `<td class="${cls}">${display}</td>`;
            });
            tr.innerHTML = html;
            tbody.appendChild(tr);
        });
    }

    function toggleView() {
        isTableView = !isTableView;
        const chartBox = document.getElementById('chartContainer');
        const tableBox = document.getElementById('tableContainer');
        const btn = document.querySelector('.toggle-btn');

        if(isTableView) {
            chartBox.style.display = 'none';
            tableBox.style.display = 'block';
            btn.innerText = "切換至：趨勢圖表";
        } else {
            chartBox.style.display = 'block';
            tableBox.style.display = 'none';
            btn.innerText = "切換至：詳細表格";
        }
    }

    init();
</script>
</body>
</html>
