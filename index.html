<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>台灣壽險業 RBC 檔案還原看板</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #2980b9;
            --bg: #f8f9fa;
            --sidebar-w: 260px;
        }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; background: var(--bg); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Header */
        header { height: 50px; background: var(--primary); color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 100; }
        h1 { margin: 0; font-size: 1rem; font-weight: bold; letter-spacing: 1px; }
        .source-badge { font-size: 0.75rem; background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.3); }

        /* Layout */
        .container { display: flex; flex: 1; overflow: hidden; position: relative; }
        
        /* Sidebar */
        .sidebar { width: var(--sidebar-w); background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; padding: 10px; overflow-y: auto; flex-shrink: 0; z-index: 50; }
        .sidebar h3 { font-size: 0.85rem; color: #7f8c8d; margin: 10px 0 5px 0; border-bottom: 2px solid #eee; padding-bottom: 5px; font-weight: bold; }
        
        button.btn-filter { display: block; width: 100%; padding: 10px; margin-bottom: 5px; border: 1px solid #eee; background: #fff; text-align: left; cursor: pointer; border-radius: 6px; font-size: 0.9rem; transition: 0.2s; }
        button.btn-filter:hover { background: #eaf2f8; border-color: var(--accent); color: var(--accent); }
        button.btn-filter strong { display: block; font-size: 0.75rem; color: #888; margin-top: 3px; font-weight: normal; }

        /* 倍安專屬按鈕 */
        button.btn-beian { border: 2px solid #9b59b6; background-color: #fcf4ff; color: #8e44ad; font-weight: bold; }
        button.btn-beian:hover { background-color: #f5eef9; }
        
        /* 全選按鈕 */
        button.btn-all { background-color: #e0e0e0; border-color: #bbb; color: #333; font-weight: bold; }

        .toggle-btn { background: var(--accent); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-bottom: 10px; width: 100%; font-size: 0.95rem; }
        
        .checkbox-item { display: flex; align-items: center; gap: 8px; padding: 8px 5px; cursor: pointer; font-size: 0.9rem; border-bottom: 1px solid #f9f9f9; }
        .checkbox-item input { transform: scale(1.3); margin: 0; }

        /* Content */
        .content { flex: 1; padding: 15px; display: flex; flex-direction: column; position: relative; overflow: hidden; min-width: 0; }
        .chart-box { flex: 1; background: white; padding: 10px; border-radius: 8px; border: 1px solid #ddd; position: relative; min-height: 0; }
        .table-box { flex: 1; background: white; border-radius: 8px; border: 1px solid #ddd; overflow: auto; display: none; -webkit-overflow-scrolling: touch; }

        /* Table */
        table { width: 100%; border-collapse: separate; border-spacing: 0; white-space: nowrap; font-size: 0.85rem; }
        th, td { padding: 10px 12px; text-align: center; border-bottom: 1px solid #eee; border-right: 1px solid #eee; }
        thead th { position: sticky; top: 0; background: var(--primary); color: white; z-index: 10; padding: 10px; }
        tbody td:first-child { position: sticky; left: 0; background: #f8f9fa; font-weight: bold; border-right: 2px solid #ccc; z-index: 11; color: var(--primary); }
        thead th:first-child { position: sticky; left: 0; z-index: 12; background: var(--primary); color: #f1c40f; }
        tbody tr:hover td { background: #fff8e1; }

        /* Status Colors */
        .val-danger { color: #c0392b; font-weight: bold; background: #fadbd8; }
        .val-high { color: #27ae60; font-weight: bold; }
        .footer { font-size: 0.75rem; color: #777; margin-top: 10px; text-align: right; border-top: 1px solid #ddd; padding-top: 5px; }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container { flex-direction: column; overflow: visible; height: auto; }
            body { overflow-y: auto; height: auto; }
            .sidebar { width: 100%; max-height: 350px; border-right: none; border-bottom: 2px solid #ddd; }
            .content { height: 600px; overflow: visible; flex: none; }
            .chart-box { min-height: 400px; }
            h1 { font-size: 0.9rem; }
            .source-badge { display: none; }
        }
    </style>
</head>
<body>

<header>
    <h1>壽險業 RBC 檔案還原數據</h1>
    <div class="source-badge">資料來源：上傳檔案 (104-114)</div>
</header>

<div class="container">
    <div class="sidebar">
        <button class="toggle-btn" onclick="toggleView()">切換檢視：圖表 / 表格</button>

        <h3>合作夥伴專區</h3>
        <button class="btn-filter btn-beian" onclick="filter('beian')">
            ★ 倍安代理 (9家)
            <strong>新光、台灣、全球、遠雄、安達、友邦、保誠、元大、富邦</strong>
        </button>

        <h3>一般分類</h3>
        <button class="btn-filter" onclick="filter('top6')">六大壽險</button>
        <button class="btn-filter" onclick="filter('high')">高資本群 (安聯/法巴...)</button>
        <button class="btn-filter" onclick="filter('watch')">觀察名單 (三商/宏泰)</button>
        
        <button class="btn-filter" style="background:#f1f1f1; border-color:#ccc;" onclick="reset()">清除所有選擇</button>
        <button class="btn-filter btn-all" onclick="selectAll()">顯示全部 (21家)</button>

        <h3>公司列表</h3>
        <div id="checkboxList"></div>
    </div>

    <div class="content">
        <div id="chartContainer" class="chart-box">
            <canvas id="myChart"></canvas>
        </div>
        <div id="tableContainer" class="table-box">
            <table id="dataTable">
                <thead><tr id="tableHead"></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        <div class="footer">
            * 數據嚴格依據檔案內容還原 | 臺銀人壽與安達人壽已依照檔案校正
        </div>
    </div>
</div>

<script>
    // =========================================================================
    // 資料來源：依據上傳檔案內容 (File Content)
    // 期間：104上 - 114上 (共21個數據點)
    // =========================================================================
    const labels = [
        "104上", "104全", "105上", "105全", "106上", "106全", "107上", "107全",
        "108上", "108全", "109上", "109全", "110上", "110全", "111上", "111全",
        "112上", "112全", "113上", "113全", "114上"
    ];

    const db = [
        // --- 倍安代理 (9家) ---
        { c: "新光人壽", data: [300.0, 268.0, 227.0, 279.0, 274.0, 257.0, 268.0, 227.0, 244.0, 221.0, 211.0, 213.0, 221.0, 230.0, 238.0, 214.0, 184.0, 176.0, 201.0, 221.0, 205.0] },
        { c: "台灣人壽", data: [275.0, 324.0, 288.0, 281.0, 345.0, 340.0, 320.0, 268.0, 322.0, 298.0, 293.0, 309.0, 306.0, 342.0, 312.0, 275.0, 289.0, 305.0, 328.0, 318.0, 323.0] },
        { c: "全球人壽", data: [300.0, 754.0, 627.0, 591.0, 522.0, 535.0, 505.0, 427.0, 430.0, 372.0, 359.0, 353.0, 388.0, 366.0, 427.0, 366.0, 317.0, 278.0, 288.0, 274.0, 212.0] },
        { c: "遠雄人壽", data: [300.0, 371.0, 362.0, 337.0, 337.0, 326.0, 326.0, 276.0, 300.0, 269.0, 257.0, 278.0, 290.0, 311.0, 322.0, 325.0, 322.0, 317.0, 303.0, 300.0, 333.0] },
        
        // ★★★ 安達人壽 (依檔案) ★★★
        { c: "安達人壽", data: [300.0, 569.0, 673.0, 587.0, 463.0, 298.0, 286.0, 369.0, 418.0, 355.0, 352.0, 336.0, 300.0, 310.0, 352.0, 545.0, 662.0, 681.0, 623.0, 569.0, null] },
        
        { c: "友邦人壽", data: [300.0, 441.0, 417.0, 439.0, 412.0, 381.0, 395.0, 381.0, 361.0, 363.0, 322.0, 439.0, 507.0, 564.0, 660.0, 649.0, 563.0, 530.0, 424.0, 441.0, 486.0] },
        { c: "保誠人壽", data: [300.0, 386.0, 301.0, 423.0, 399.0, 366.0, 446.0, 493.0, 399.0, 324.0, 435.0, 316.0, 307.0, 339.0, 545.0, 458.0, 331.0, 315.0, 292.0, 294.0, 264.0] },
        { c: "元大人壽", data: [300.0, 410.0, 358.0, 293.0, 414.0, 313.0, 358.0, 367.0, 327.0, 300.0, 469.0, 597.0, 445.0, 561.0, 518.0, 503.0, 498.0, 465.0, 368.0, 396.0, 415.0] },
        { c: "富邦人壽", data: [300.0, 256.0, 262.0, 301.0, 284.0, 318.0, 327.0, 278.0, 288.0, 281.0, 248.0, 299.0, 333.0, 338.0, 349.0, 317.0, 315.0, 336.0, 388.0, 371.0, 405.0] },

        // --- 其他公司 ---
        // ★★★ 台銀人壽 (依檔案修正) ★★★
        { c: "臺銀人壽", data: [225.0, 233.0, 213.0, 189.0, 151.0, 154.0, 303.0, 258.0, 268.0, 223.0, 212.0, 176.0, 297.0, 288.0, 307.0, 282.0, 312.0, 298.0, 336.0, 356.0, 204.0] },

        { c: "國泰人壽", data: [275.0, 305.0, 288.0, 305.0, 308.0, 309.0, 325.0, 292.0, 333.0, 346.0, 347.0, 360.0, 371.0, 371.0, 337.0, 316.0, 312.0, 323.0, 359.0, 352.0, 328.0] },
        { c: "南山人壽", data: [275.0, 239.0, 237.0, 257.0, 272.0, 268.0, 272.0, 215.0, 258.0, 274.0, 256.0, 260.0, 295.0, 327.0, 318.0, 286.0, 292.0, 280.0, 282.0, 299.0, 276.0] },
        { c: "凱基人壽", data: [300.0, 357.0, 339.0, 369.0, 334.0, 350.0, 303.0, 272.0, 319.0, 305.0, 276.0, 288.0, 306.0, 325.0, 331.0, 280.0, 300.0, 340.0, 323.0, 398.0, 347.0] },
        { c: "安聯人壽", data: [225.0, 237.0, 325.0, 286.0, 248.0, 340.0, 335.0, 312.0, 493.0, 646.0, 707.0, 775.0, 842.0, 732.0, 761.0, 721.0, 577.0, 780.0, 469.0, 468.0, 447.0] },
        
        // ★★★ 法國巴黎 (依檔案修正) ★★★
        { c: "法國巴黎", data: [300.0, 415.0, 683.0, 896.0, 818.0, 787.0, 805.0, 786.0, 807.0, 769.0, 1094.0, 1223.0, 1348.0, 1094.0, 976.0, 1380.0, 2176.0, 2291.0, 1672.0, 1012.0, 842.0] },
        
        { c: "中華郵政", data: [300.0, 324.0, 311.0, 351.0, 322.0, 355.0, 324.0, 291.0, 280.0, 251.0, 212.0, 291.0, 307.0, 333.0, 264.0, 324.0, 290.0, 256.0, 310.0, 274.0, 231.0] },
        { c: "合庫人壽", data: [300.0, 887.0, 1078.0, 1016.0, 1100.0, 1152.0, 1162.0, 1098.0, 1311.0, 1148.0, 1592.0, 1618.0, 1784.0, 1503.0, 1301.0, 1403.0, 1563.0, 1576.0, 1373.0, 1285.0, 1415.0] },
        
        // ★★★ 第一金 (依檔案修正) ★★★
        { c: "第一金人壽", data: [300.0, 356.0, 379.0, 228.0, 263.0, 231.0, 454.0, 407.0, 320.0, 344.0, 368.0, 326.0, 394.0, 377.0, 614.0, 609.0, 488.0, 471.0, 425.0, 424.0, 359.0] },
        
        { c: "台新人壽", data: [300.0, 393.0, 393.0, 362.0, 320.0, 315.0, 327.0, 308.0, 325.0, 302.0, 287.0, 269.0, 320.0, 317.0, 410.0, 371.0, 339.0, 353.0, 323.0, 349.0, 458.0] },
        { c: "三商美邦", data: [225.0, 219.0, 211.0, 231.0, 226.0, 227.0, 217.0, 218.0, 208.0, 218.0, 210.0, 205.0, 210.0, 204.0, 190.0, 156.0, 140.0, 111.0, 151.0, 136.0, 154.0] },
        { c: "宏泰人壽", data: [150.0, 307.0, 291.0, 295.0, 309.0, 290.0, 251.0, 225.0, 227.0, 239.0, 207.0, 164.0, 232.0, 259.0, 228.0, 205.0, 146.0, 215.0, 242.0, 272.0, 250.0] }
    ];

    const groups = {
        // 倍安代理 9 家
        beian: ["新光人壽", "台灣人壽", "全球人壽", "遠雄人壽", "安達人壽", "友邦人壽", "保誠人壽", "元大人壽", "富邦人壽"],
        
        top6: ["國泰人壽", "富邦人壽", "南山人壽", "新光人壽", "凱基人壽", "台灣人壽"],
        watch: ["三商美邦", "新光人壽", "宏泰人壽"],
        high: ["安聯人壽", "友邦人壽", "安達人壽", "法國巴黎"]
    };

    let chartInstance = null;
    let isTableView = false;

    function init() {
        const cbList = document.getElementById('checkboxList');
        db.forEach(item => {
            const div = document.createElement('label');
            div.className = 'checkbox-item';
            div.innerHTML = `<input type="checkbox" value="${item.c}" onchange="refresh()"> ${item.c}`;
            cbList.appendChild(div);
        });
        filter('beian'); // 預設顯示倍安代理
    }

    function filter(key) {
        const targets = groups[key] || [];
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.checked = targets.includes(cb.value);
        });
        refresh();
    }

    function selectAll() {
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.checked = true;
        });
        refresh();
    }

    function reset() {
        document.querySelectorAll('input').forEach(i => i.checked = false);
        refresh();
    }

    function refresh() {
        const selected = Array.from(document.querySelectorAll('input:checked')).map(i => i.value);
        if(selected.length === 0) {
            if(chartInstance) chartInstance.destroy();
            document.getElementById('tableBody').innerHTML = '';
            return;
        }
        updateChart(selected);
        updateTable(selected);
    }

    function updateChart(selectedNames) {
        const ctx = document.getElementById('myChart').getContext('2d');
        const datasets = selectedNames.map((name, idx) => {
            const item = db.find(d => d.c === name);
            let color = `hsl(${idx * 40 % 360}, 70%, 50%)`;
            if(name === "三商美邦") color = "#c0392b";
            if(name === "安達人壽") color = "#8e44ad";
            if(name === "臺銀人壽") color = "#e67e22";
            
            return {
                label: name,
                data: item.data,
                borderColor: color,
                backgroundColor: color,
                borderWidth: 2,
                tension: 0.1,
                pointRadius: 3,
                spanGaps: true
            };
        });

        datasets.push({
            label: '法定標準 200%',
            data: Array(labels.length).fill(200),
            borderColor: 'red',
            borderWidth: 2,
            borderDash: [5, 5],
            pointRadius: 0,
            order: 999
        });

        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    y: { beginAtZero: false, title: { display: true, text: 'RBC (%)' } }
                },
                plugins: {
                    tooltip: { mode: 'index', intersect: false }
                }
            }
        });
    }

    function updateTable(selectedNames) {
        const thead = document.getElementById('tableHead');
        const tbody = document.getElementById('tableBody');
        
        thead.innerHTML = `<th>公司 \\ 期別</th>` + labels.map(l => `<th>${l}</th>`).join('');
        tbody.innerHTML = '';
        
        selectedNames.forEach(name => {
            const item = db.find(d => d.c === name);
            const tr = document.createElement('tr');
            let html = `<td>${name}</td>`;
            
            item.data.forEach(val => {
                let cls = '';
                let display = '-';
                if(val !== null) {
                    display = val + '%';
                    if(val < 200) cls = 'val-danger';
                    else if(val > 400) cls = 'val-high';
                }
                html += `<td class="${cls}">${display}</td>`;
            });
            tr.innerHTML = html;
            tbody.appendChild(tr);
        });
    }

    function toggleView() {
        isTableView = !isTableView;
        const chartBox = document.getElementById('chartContainer');
        const tableBox = document.getElementById('tableContainer');
        const btn = document.querySelector('.toggle-btn');

        if(isTableView) {
            chartBox.style.display = 'none';
            tableBox.style.display = 'block';
            btn.innerText = "切換至：趨勢圖表";
        } else {
            chartBox.style.display = 'block';
            tableBox.style.display = 'none';
            btn.innerText = "切換至：詳細表格";
        }
    }

    init();
</script>
</body>
</html>
